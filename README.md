# 7주차

## 구현 게획

웹 서비스에 사용되는 전체 인프라를 코드로 관리한다.

키워드 |  [Infrastructure as code (IaC)](https://en.wikipedia.org/wiki/Infrastructure_as_code) | [CloudFormation](https://aws.amazon.com/cloudformation/) | [CDK](https://docs.aws.amazon.com/cdk/latest/guide/home.html) |

## 도전 이유

마이크로 서비스, 도커, CI/CD를 고민하면서 전체 인프라의 관리에 대한 일괄된 방법이 필요하였습니다. 

도커 + 컨테이너 오케스트레이션 도구 를 활용하여 애플리케이션을 관리하고, 인프라에 대한 provision을 코드로 관리하는 방식은 이상적인 관리 방식으로 구성이 복잡하지 않은 현 시점에서 구성을 도전해볼만 할 목표라 생각하였습니다. 

이미 구축되어있는 CI 도구와 Server에 대한 부분들이 있었지만, 
재사용 가능한 부분이 많이 부족하였고 도커화가 진행되있지 않았습니다. 

결과적으로 다음과 같은 부분들을 추가로 제공해 보고자 도전하게 되었습니다. 

- 마이크로 서비스 아키텍쳐를 고민하면서 service discovery 부분에 대해서 일관된 방법을 제공한다
- CI/CD 과정에서 local-test-stage-production에서 하나의 방법으로 전체 애플리케이션이 구성된다
- auto scaling, load balancing, failover 등 인프라 관리에서 필수적인 요소를 구현한다
- 전체 인프라와 인증/권한 과정이 명확하게 볼 수 있도록 한다
- 사람의 손으로 작업되는 부분들을 최소화 한다

## 고민들

### 도구에 대한 부분 (IaC)

IaC에 대한 도구로 CloudFormation, Terraform, AWS CDK등을 고민하였지만, AWS CDK로 결정하였습니다. 그 이유로는 

- 타입스크립트를 제공하여 현재 작업하는 리소스에 대한 필요 요소들을 쉽게 제공받을 수 있습니다
- 코드의 가독성이 훨씬 뛰어나고, 개발자가 작성할 코드의 양이 현저히 적음에도 cloudformation, terraform과 유사한 결과를 제공합니다
- 사용과 관련하여 best practice와 같은 방식을 기본적으로 녹여 제공합니다.

단점으로는, 아직 베타 서비스이고 관련 자료가 많이 부족합니다. 

### 도구에 대한 부분 (컨테이너 서비스)

docker를 사용합니다. 

### 도구에 대한 부분 (컨테이너 오케스트레이션 도구)

kubernetes가 업계에서 표준과 같이 쓰이고, docker compose, swam등의 방법들 또한 존재합니다. 
애초에 여러 Node에서 컨테이너(애플리케이션)을 실행할 계획을 갖고 있었기 때문에 compose는 제외하였습니다. 또한 swam과 비교하여 k8s가 크게 복잡하지 않아 보였고, 미래에 더 많이 사용될 기술인 k8s를 사용하게 되었습니다. 

그를 위해 AWS혹은 Ncloud 위에서 k8s를 사용할 수 있는 방법들에 조사를 하였으며 위에 언급하였듯이 CDK를 적용하고자 하는 결정에 따라 AWS위에서 k8s를 사용하는 방법인 EKS, kops에 대해 조사하였습니다.


우선, EKS는 AWS를 사용하는 상황에서는 k8s를 컨테이너 오케스트레이션 도구로서 사용될 때 많은 분들이 최종적인 선택지로 가져가는 서비스 입니다. k8s가 이미 시장에서 높은 인기를 갖고 있고, AWS에서 이를 안정되고 관리가 편리한 방법으로 제공하여 큰 인기가 있습니다. [참고 타다: 서비스 중단 없이 Amazon EKS로 옮긴 이야기](http://engineering.vcnc.co.kr/2019/02/eks-migration/)

EKS는 k8s Master에 대한 부분을 완전 관리형으로 제공하고, 그 편리함이 크지만 가격적인 요소때문에 사용할 수 없었습니다. 한달동안 사용시에 약 17만원의 비용이 발생하고 포트폴리오로서 사용될 프로젝트이므로 오랜기간 유지 되어야 하기에 금정적인 요인으로 선택할 수 없었습니다. 

대안으로 선택하였던 방법이 EKS이전에 AWS에서 k8s를 쓰기 위해 많이 사용된 kops가 있습니다. 
kops를 master node 3대를 nano/micro로 운영한다면 가격적인 부담이 덜 할것이라는 결정에서 선택하였습니다. 

그러나 결과적으로 가장 처음에 나온 CDK & IaC에 대한 결정을 고수하기 위해 kops의 사용도 포기하였습니다. kops가 좋은 도구임에는 분명하지만, CLI도구로서 code로 인프라가 관리되기 보다는 명령어를 통해 보이지 않는 방식으로 인프라가 한번에 올라가는 특성을 갖습니다. 이는 개발자의 입장에서 매우 손쉬운 방법으로 인프라를 구축/관리할 수 있다는 장점이 있지만, 전체 인프라를 하나의 유일한 코드 베이스로 관리하고자 하는 첫번쨰 결정에 녹이기 어려웠습니다. 

물론 kops또한 terraform으로의 export를 지원하지만, 이번 프로젝트에서는 AWS의 CDK가 제공하는 선언형식의 인프라 구축/관리를 활용하고 싶은 마음이 커서 선택지에서 제외하였습니다. 

결과적으로, 컨테이너 오케스트레이션 도구로는 AWS에서 제공하는 ECS를 사용하게 되었습니다. 
ECS는 k8s와 호환되는 형태는 아니지만, 그 아이디어가 매우 흡사한듯 합니다. 따라서 k8s에서 다른 오케스트레이션 도구를 고민하기 위해서 가장 우선적으로 선택하였던 옵션입니다. 
또한, AWS ECS를 사용시에 VPC, IAM 등을 조금 더 살펴볼 수 있고 모든 구성요소들이 코드로(CDK) 관리될 수 있는 장점도 있었습니다. 

## 어려웠던 부분들

가장 어려웠던 부분은, 도전적으로 짧은 시간에 관련 내용을 습득하고 구현해야 하기 때문에 제 자신의 멘탈을 관리하기 어려웠습니다. 하나를 알게되면 그와 관련된 새로운 내용들이 계속해서 튀어나와서, 처음 컨테아너 오케스트레이션 도구가 사용이 쉬울것이라는 가정이 잘못되었다는 것을 알게 되기까지 얼마 걸리지 않았습니다. 

컨테이너 오케스트레이션 도구에서 어려웠던 부분들은, 용어가 주는 생소함에서 온것 같습니다. k8s의 service, ECS의 task등 일반적으로도 많이 쓰이는 용어가 별도의 의미를 갖는 구성요소로서 제공되니 그 의미를 파악하기 어려웠습니다. 그로 인해 자료를 하나하나 살펴봐야 했습니다. 

여러 어려움으로 인해 학습에 많은 시간이 들었고, 계획대로 코드를 아직 작성하지 못했습니다. 그러나, 일요일까지 완성을 목표로 계속 해나가고 있습니다. 

## 이해가 잘 안가던 부분들

### AWS Cloud map (service discovery)

이 서비스가 Route53과 연결되어 DNS와 같은 기능을 제공하지만, 결국 API server나 Client단에서 resource에 요청/응답을 받기위해 resource를 찾는 과정에서 하나 이상의 결과가 나오게 되고, 결과적으로 결과중에 선택을 위한 가공이 필요한데 이를 추상화 하여 하나의 주소로 관리할 방법으로의 활용법을 이해하기 어렵습니다. 

예를 들어, Cloud map으로 `myapp`을 찾으면, 이에 대응되는 두개의 경로가 나온다고 가정하면, `{10.10.10.10:1111, 10.10.10.11:1111} 이 중에서 어떤 경로를 사용해야 하는지 알지 못하겠습니다. 

### ECS에서 Servise, cluster에 대한 구분

ECS에서 task가 하나 이상의 컨테이너를 갖는, k8s에서의 pod와 같은 의미의 존재임을 알고 있습니다. 
그러나, service 와 cluster가 어떤 의미를 갖고 어떤 제약을 갖는지 명확한 구분에 대한 자료를 찾지 못하고 있습니다. 

